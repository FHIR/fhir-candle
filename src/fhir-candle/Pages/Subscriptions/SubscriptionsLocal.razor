@using Microsoft.FluentUI.AspNetCore.Components;

@page "/subscriptions/local"

@inject NavigationManager NavigationManager
@inject IFhirStoreManager StoreManager

@implements IDisposable

<PageTitle>Local Subscriptions</PageTitle>

<FluentGrid Spacing="4">
    @foreach (ParsedSubscription sub in _store?.CurrentSubscriptions ?? Array.Empty<ParsedSubscription>())
    {
        <FluentGridItem xs="12">
            <FluentCounterBadge Count="@sub.GeneratedEvents.Count()" Appearance="Appearance.Accent" BottomPosition="97" HorizontalPosition="97" Max="999">
                <FluentCard>
                    <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                        <FluentLabel Typo="Typography.Body">Subscription</FluentLabel>
                        <FluentAnchor Appearance="Appearance.Hypertext" Href="@($"/store/resource-viewer?store={StoreName}&type=Subscription&id={sub.Id}")">Subscription/@sub.Id</FluentAnchor>

                        <FluentTextField Label="Topic" ReadOnly="true" ValueExpression="@sub.TopicUrl"/>
                        <FluentTextField Label="Channel" ReadOnly="true" ValueExpression="@sub.ChannelCode"/>
                        <FluentTextField Label="Endpoint" ReadOnly="true" ValueExpression="@sub.Endpoint"/>

                        <FluentLabel Typo="Typography.Body">Generated Event Details</FluentLabel>
                        <FluentAnchor Appearance="Appearance.Hypertext" Href="@($"/subscriptions/notification-local-viewer?store={StoreName}&id={sub.Id}")">Generated Events</FluentAnchor>

                        @if (sub.GeneratedEvents.Any())
                        {
                            <FluentTextField Label="Latest" ReadOnly="true" ValueExpression="@HeaderFor(sub.GeneratedEvents.Last().Value)" />
                        }
                        @if (sub.NotificationErrors.Any())
                        {
                            <FluentTextField Label="Error" Error="true" ReadOnly="true" ValueExpression="@sub.NotificationErrors.Last()" />
                        }
                    </FluentStack>
                </FluentCard>
            </FluentCounterBadge>
        </FluentGridItem>
    }
</FluentGrid>

@code {
        /// <summary>Gets or sets the navigation tracker.</summary>
        [CascadingParameter]
        public INavTracker? NavTracker { get; set; } = null;

        /// <summary>Gets or sets the package name.</summary>
        [Parameter]
        [SupplyParameterFromQuery(Name = "store")]
        public string StoreName { get; set; } = "";

    private IFhirStore _store = null!;

    /// <summary>Executes the initialized asynchronous action.</summary>
    /// <returns>An asynchronous result.</returns>
    protected override void OnInitialized()
    {
        base.OnInitialized();

        if ((!string.IsNullOrEmpty(StoreName)) &&
            (StoreManager.TryGetValue(StoreName, out _store!)))
        {
            _store.OnInstanceCreated += Store_OnChanged;
            _store.OnInstanceDeleted += Store_OnChanged;
            _store.OnSubscriptionSendEvent += Store_OnSubscriptionSendEvent;
            _store.OnSubscriptionsChanged += Store_OnSubscriptionsChanged;
        }

        // notify of store root in case user clicked here directly
        NavTracker?.NotifyNav(StoreName, "/store?store=" + StoreName, 1);
        NavTracker?.NotifyNav($"Local Subscriptions", "/subscriptions/local?store=" + StoreName, 2);
    }

    /// <summary>Handles the location changed.</summary>
    /// <param name="sender">The sender.</param>
    /// <param name="e">     Location changed event information.</param>
    private void HandleLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        if (e.Location.ToLowerInvariant().Contains("/subscriptions/local", StringComparison.Ordinal))
        {
            if (_store != null)
            {
                _store.OnInstanceCreated -= Store_OnChanged;
                _store.OnInstanceDeleted -= Store_OnChanged;
                _store.OnSubscriptionSendEvent -= Store_OnSubscriptionSendEvent;
                _store.OnSubscriptionsChanged -= Store_OnSubscriptionsChanged;
            }

            if ((!string.IsNullOrEmpty(StoreName)) &&
                (StoreManager.TryGetValue(StoreName, out _store!)))
            {
                _store.OnInstanceCreated += Store_OnChanged;
                _store.OnInstanceDeleted += Store_OnChanged;
                _store.OnSubscriptionSendEvent += Store_OnSubscriptionSendEvent;
                _store.OnSubscriptionsChanged += Store_OnSubscriptionsChanged;
            }

            // notify of store root in case user clicked here directly
            NavTracker?.NotifyNav(StoreName, "/store?store=" + StoreName, 1);
            NavTracker?.NotifyNav($"Local Subscriptions", "/subscriptions/local?store=" + StoreName, 2);
        }
    }

    /// <summary>Header for.</summary>
    /// <param name="subEvent">The sub event.</param>
    /// <returns>A string.</returns>
    private string HeaderFor(SubscriptionEvent subEvent)
    {
        return $"{subEvent.EventNumber}: {subEvent.Timestamp.ToLocalTime().ToString("O")}...";
    }

    /// <summary>Event handler. Called by Store when a subscription changes.</summary>
    /// <param name="sender">The sender.</param>
    /// <param name="e">     Subscription event information.</param>
    private void Store_OnSubscriptionsChanged(object? sender, SubscriptionChangedEventArgs e)
    {
        InvokeAsync(() => StateHasChanged());
    }

    /// <summary>Event handler. Called by Store for on subscription events.</summary>
    /// <param name="sender">The sender.</param>
    /// <param name="e">     Subscription event information.</param>
    private void Store_OnSubscriptionSendEvent(object? sender, SubscriptionSendEventArgs e)
    {
        InvokeAsync(() => StateHasChanged());
    }

    /// <summary>FHIR store on changed.</summary>
    /// <param name="sender">The sender.</param>
    /// <param name="e">     Event information.</param>
    private void Store_OnChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() => StateHasChanged());
    }

    /// <summary>
    /// Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged
    /// resources.
    /// </summary>
    public void Dispose()
    {
        if (_store != null)
        {
            _store.OnInstanceCreated -= Store_OnChanged;
            _store.OnInstanceDeleted -= Store_OnChanged;
            _store.OnSubscriptionSendEvent -= Store_OnSubscriptionSendEvent;
            _store.OnSubscriptionsChanged -= Store_OnSubscriptionsChanged;
        }
    }
}

